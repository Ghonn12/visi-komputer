<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minggu 2 – Deteksi Warna Kulit (KNN, MLP, Bayes)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    body {
      background: #f8f9fa;
    }

    .card {
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .navbar-brand {
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .result-img {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      transition: 0.4s ease;
    }

    .result-img:hover {
      transform: scale(1.02);
    }

    .placeholder-box {
      background: #f1f1f1;
      border-radius: 10px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      transition: 0.3s ease;
    }

    .btn-custom {
      transition: 0.3s;
    }

    .btn-custom:hover {
      transform: scale(1.03);
    }

    .roc-container {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    video,
    canvas {
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    /* Style untuk spinner yang lebih besar */
    .spinner-border-lg {
      width: 3rem;
      height: 3rem;
      border-width: .35em;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="fas fa-braille me-2"></i>GLCM & KNN System
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('index') }}">Minggu 1 - GLCM Dasar</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('tugas2') }}">
              Minggu 2 - Deteksi Warna Kulit
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('tugas3') }}">Minggu 3 - Decision Tree</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-lg-4 mb-4">
        <div class="card p-3">
          <h5 class="mb-3"><i class="fa-solid fa-palette me-2"></i>Konfigurasi Model</h5>
          <form id="skinForm">

            <!-- === MODIFIKASI: Tambah Dropdown Algoritma === -->
            <div class="mb-3">
              <label class="form-label">1️⃣ Pilih Algoritma</label>
              <select class="form-select" id="algorithm">
                <option value="knn">K-Nearest Neighbor (KNN)</option>
                <option value="mlp">Multilayer Perceptron (MLP)</option>
                <option value="nb">Gaussian Naive Bayes (NB)</option>
              </select>
            </div>
            <!-- === AKHIR MODIFIKASI === -->

            <div class="mb-3">
              <label class="form-label">2️⃣ Pilih Nilai K (Hanya untuk KNN)</label>
              <select class="form-select" id="k_value">
                <option value="1">K = 1 (Sesuai Jurnal IB1)</option>
                <option value="3" selected>K = 3</option>
                <option value="5">K = 5</option>
                <option value="7">K = 7</option>
                <!-- TAMBAHKAN OPSI BARU DI SINI -->
                <option value="9">K = 9</option>
                <option value="11">K = 11</option>
                <option value="15">K = 15</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">3️⃣ Ruang Warna</label>
              <select class="form-select" id="color_space" disabled>
                <option value="RGB" selected>BGR (Sesuai Dataset UCI)</option>
              </select>
              <small class="form-text text-muted">Model dilatih pada BGR. Pilihan ini dinonaktifkan.</small>
            </div>

            <div class="mb-3">
              <label class="form-label">4️⃣ Unggah Gambar</label>
              <input class="form-control" type="file" id="imageInput" accept="image/*" required>
            </div>

            <button class="btn btn-primary w-100 btn-custom" type="submit">
              <i class="fa-solid fa-play me-2"></i>Proses Deteksi
            </button>
          </form>
        </div>

        <div class="card p-3 mt-3 text-center">
          <h6 class="mb-2"><i class="fa-solid fa-chart-line me-2"></i>Evaluasi Model (ROC Curve)</h6>
          <button id="btnEval" class="btn btn-outline-success w-100 btn-custom">
            <i class="fa-solid fa-microscope me-1"></i>Tampilkan Evaluasi
          </button>
          <div id="rocContainer" class="mt-3"></div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-4">
          <h5 class="mb-3"><i class="fa-solid fa-image me-2"></i>Hasil Deteksi Warna Kulit</h5>
          <div class="row text-center">
            <div class="col-md-6">
              <h6>Gambar Asli</h6>
              <div id="beforeBox" class="placeholder-box">
                <span>Belum ada gambar</span>
              </div>
            </div>
            <div class="col-md-6">
              <h6>Hasil Segmentasi</h6>
              <div id="afterBox" class="placeholder-box">
                <span>Belum ada hasil</span>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <h5 class="text-center"><i class="fa-solid fa-camera me-2"></i>Deteksi Langsung dari Kamera</h5>
          <div class="text-center">
            <video id="video" width="400" height="300" autoplay playsinline></video>
            <canvas id="canvas" width="400" height="300" class="d-none"></canvas><br>
            <button id="captureBtn" class="btn btn-primary mt-3 btn-custom">
              <i class="fa-solid fa-camera me-2"></i>Ambil & Deteksi
            </button>
          </div>
          <div class="text-center mt-4" id="cameraResult"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // --- MODIFIKASI: Kontrol UI ---
    const algorithmSelect = document.getElementById('algorithm');
    const kValueSelect = document.getElementById('k_value');
    const colorSpaceSelect = document.getElementById('color_space'); // Ambil dropdown color_space

    algorithmSelect.addEventListener('change', () => {
      // Hanya aktifkan 'K' jika algoritma adalah 'knn'
      kValueSelect.disabled = (algorithmSelect.value !== 'knn');
    });
    // --- AKHIR MODIFIKASI ---

    let rocData = null; // Pindahkan rocData ke scope global

    // ================= IMAGE UPLOAD PROCESS =================
    document.getElementById('skinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('imageInput').files[0];
      if (!file) {
        alert('Pilih gambar terlebih dahulu!');
        return;
      }
      const formData = new FormData();
      formData.append('image', file);
      // --- MODIFIKASI: Kirim Algoritma ---
      formData.append('algorithm', algorithmSelect.value); // Gunakan variabel
      formData.append('k_value', kValueSelect.value); // Gunakan variabel
      formData.append('color_space', colorSpaceSelect.value); // Gunakan variabel
      // --- AKHIR MODIFIKASI ---

      const beforeBox = document.getElementById('beforeBox');
      const afterBox = document.getElementById('afterBox');
      const rocContainer = document.getElementById('rocContainer');
      const btnEval = document.getElementById('btnEval');

      // Tampilkan spinner besar
      beforeBox.innerHTML = '<div class="spinner-border text-primary spinner-border-lg" role="status"><span class="visually-hidden">Loading...</span></div>';
      afterBox.innerHTML = '<div class="spinner-border text-primary spinner-border-lg" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Memproses... Ini mungkin perlu waktu lama jika model belum di-cache.</p>';
      beforeBox.classList.add('placeholder-box');
      afterBox.classList.add('placeholder-box');

      // Kosongkan ROC dan reset tombol
      rocContainer.innerHTML = "";
      rocData = null;
      btnEval.innerHTML = '<i class="fa-solid fa-microscope me-1"></i>Tampilkan Evaluasi';
      btnEval.classList.remove('btn-outline-danger');
      btnEval.classList.add('btn-outline-success');


      const res = await fetch('/skin_process', { method: 'POST', body: formData });

      // Tambah delay kecil agar UI spinner sempat muncul
      await new Promise(resolve => setTimeout(resolve, 100));

      const data = await res.json();

      if (data.status === 'success') {
        beforeBox.classList.remove('placeholder-box');
        afterBox.classList.remove('placeholder-box');

        // Tambahkan timestamp unik untuk memaksa browser memuat ulang gambar
        const timestamp = new Date().getTime();
        beforeBox.innerHTML = `<img src="${data.original_image}?t=${timestamp}" class="result-img" alt="original">`;
        afterBox.innerHTML = `<img src="${data.segmented_image}?t=${timestamp}" class="result-img" alt="segmented">`;

        document.getElementById('cameraResult').innerHTML = '';

        if (data.fpr && data.tpr && data.roc_auc) {
          rocData = {
            fpr: data.fpr,
            tpr: data.tpr,
            roc_auc: data.roc_auc
          };
          // Otomatis klik tombol untuk tampilkan ROC
          btnEval.click();
        }
      }
      else {
        beforeBox.innerHTML = '<span>Belum ada gambar</span>';
        afterBox.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
        beforeBox.classList.add('placeholder-box');
        afterBox.classList.add('placeholder-box');
      }
    });


  </script>
  <script>
    // --- Pindahkan variabel global ke atas ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const captureBtn = document.getElementById('captureBtn');
    const cameraResult = document.getElementById('cameraResult');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("❌ Gagal mengakses kamera: " + err.message));

    captureBtn.addEventListener('click', async () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL('image/jpeg');

      // --- MODIFIKASI: Kirim Algoritma ---
      const payload = {
        image: dataURL,
        algorithm: algorithmSelect.value, // Gunakan variabel
        k_value: kValueSelect.value, // Gunakan variabel
        color_space: colorSpaceSelect.value // Gunakan variabel
      };
      // --- AKHIR MODIFIKASI ---

      cameraResult.innerHTML = `<div class="spinner-border text-primary" role="status"></div><p>Memproses...</p>`;

      const res = await fetch('/skin_camera_process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      // Tambah delay kecil agar UI spinner sempat muncul
      await new Promise(resolve => setTimeout(resolve, 100));

      const data = await res.json();
      if (data.status === 'success') {
        cameraResult.innerHTML = `
      <h6 class="mt-3">Hasil Deteksi Warna Kulit:</h6>
      <img src="${data.image}" class="img-fluid rounded border mt-2" alt="Hasil Kamera">
    `;
        // Hapus hasil unggah
        const beforeBox = document.getElementById('beforeBox');
        const afterBox = document.getElementById('afterBox');
        beforeBox.innerHTML = '<span>Belum ada gambar</span>';
        beforeBox.classList.add('placeholder-box');
        afterBox.innerHTML = '<span>Belum ada hasil</span>';
        afterBox.classList.add('placeholder-box');
        document.getElementById('imageInput').value = null;

        // --- PERBAIKAN DIMULAI ---
        // Hapus logika lama yang mengatur rocData = null

        const rocContainer = document.getElementById('rocContainer');
        const btnEval = document.getElementById('btnEval');

        // Kosongkan ROC container dan reset tombol
        rocContainer.innerHTML = "";
        btnEval.innerHTML = '<i class="fa-solid fa-microscope me-1"></i>Tampilkan Evaluasi';
        btnEval.classList.remove('btn-outline-danger');
        btnEval.classList.add('btn-outline-success');

        // SEKARANG, simpan data ROC baru dari kamera
        if (data.fpr && data.tpr && data.roc_auc) {
          rocData = {
            fpr: data.fpr,
            tpr: data.tpr,
            roc_auc: data.roc_auc
          };
          // Otomatis klik tombol untuk tampilkan ROC
          btnEval.click();
        } else {
          rocData = null; // Set ke null jika data tidak diterima
        }
        // --- PERBAIKAN SELESAI ---

      } else {
        cameraResult.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
      }
    });

  </script>

  <script>
    // SCRIPT UNTUK ROC CHART (Logika Chart.js dimodifikasi)
    function renderRocChart(fpr, tpr, auc) {
      const rocContainer = document.getElementById('rocContainer');
      rocContainer.innerHTML = `<canvas id="rocChart" width="400" height="300"></canvas>`;
      rocContainer.innerHTML += `
    <div class="mt-3">
      <p><strong>Area Under Curve (AUC):</strong> ${auc.toFixed(4)}</p>
    </div>
  `;

      const ctx = document.getElementById('rocChart').getContext('2d');

      // Ubah data agar (FPR, TPR) menjadi poin (x, y)
      const dataPoints = fpr.map((value, index) => {
        return { x: value, y: tpr[index] };
      });
      // Pastikan data terurut berdasarkan x (FPR)
      dataPoints.sort((a, b) => a.x - b.x);

      new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: `ROC Curve (AUC = ${auc.toFixed(4)})`,
            data: dataPoints, // Gunakan data poin (x,y)
            borderColor: 'blue',
            backgroundColor: 'rgba(0, 123, 255, 0.2)',
            fill: true,
            tension: 0.2,
            pointRadius: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function (context) {
                  return `TPR: ${context.parsed.y.toFixed(3)} | FPR: ${context.parsed.x.toFixed(3)}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear', // Sumbu X harus linear
              title: { display: true, text: 'False Positive Rate' },
              min: 0,
              max: 1
            },
            y: {
              type: 'linear', // Sumbu Y harus linear
              title: { display: true, text: 'True Positive Rate' },
              min: 0,
              max: 1
            }
          }
        }
      });
    }
  </script>
  <script>
    // SCRIPT TOMBOL EVALUASI (Toggle)
    document.getElementById('btnEval').addEventListener('click', () => {
      const rocContainer = document.getElementById('rocContainer');
      const btnEval = document.getElementById('btnEval');

      if (rocContainer.innerHTML.trim() !== "") {
        rocContainer.innerHTML = "";
        btnEval.innerHTML = '<i class="fa-solid fa-microscope me-1"></i>Tampilkan Evaluasi';
        btnEval.classList.remove('btn-outline-danger');
        btnEval.classList.add('btn-outline-success');
      } else {
        if (rocData) {
          renderRocChart(rocData.fpr, rocData.tpr, rocData.roc_auc);
          btnEval.innerHTML = '<i class="fa-solid fa-times me-1"></i>Tutup Evaluasi';
          btnEval.classList.remove('btn-outline-success');
          btnEval.classList.add('btn-outline-danger');
        } else {
          rocContainer.innerHTML = `<div class="alert alert-warning">Belum ada data ROC. Silakan proses gambar terlebih dahulu.</div>`;
          btnEval.innerHTML = '<i class="fa-solid fa-times me-1"></i>Tutup Peringatan';
          btnEval.classList.remove('btn-outline-success');
          // Perbaikan typo: btn_outline-danger -> btn-outline-danger
          btnEval.classList.add('btn-outline-danger');
        }
      }
    });
  </script>

</body>

</html>